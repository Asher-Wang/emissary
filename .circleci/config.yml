# Generated by `./generate`. DO NOT EDIT.

version: 2.1
# Secure environment variables set from the Web UI:
#
# - AWS_ACCESS_KEY_ID (AWS S3)
# - AWS_SECRET_ACCESS_KEY (AWS S3)
#
# - DEV_REGISTRY (DockerHub)
# - DOCKER_BUILD_USERNAME (DockerHub)
# - DOCKER_BUILD_PASSWORD (DockerHub)
#
# - RELEASE_REGISTRY (DockerHub)
# - DOCKER_RELEASE_USERNAME (DockerHub)
# - DOCKER_RELEASE_PASSWORD (DockerHub)
#
# - KUBECEPTION_TOKEN
commands:
  "oss-images-build-and-test":
    steps:
    - run:
        name: "Ensure CI configuration is up-to-date"
        command: |
          set -x
          test_targets=$(make -n noop --print-data-base 2>/dev/null | sed -n 's/^test: *//p' | xargs printf '%s\n' | LC_COLLATE=C sort -u | xargs echo)
          if [ "$test_targets" != "gotest ingresstest pytest" ]; then
            echo "Makefile 'test' target has changed to $test_targets, you need to update '.circleci/config.yml.d/oss.yml'" >&2
            exit 1
          fi

          (cd .circleci && ./generate --always-make)
          if test -n "$(git status --porcelain)"; then
            echo "The file '.circleci/config.yml' is out of date." >&2
            echo "Run '(cd .circleci && ./generate)' to update it." >&2
            exit 1
          fi
    - run:
        name: "Set up cluster and registry"
        command: |
          ./.ci/kubernaut-claim
          echo >>"$BASH_ENV" 'if test -e ~/kubernaut-claim.txt; then'
          echo >>"$BASH_ENV" '  export DEV_KUBECONFIG=~/.kube/$(cat ~/kubernaut-claim.txt).yaml'
          echo >>"$BASH_ENV" 'fi'

          if [[ -n "$DEV_REGISTRY" && -n "$DOCKER_BUILD_USERNAME" && -n "DOCKER_BUILD_PASSWORD" ]]; then
            docker login -u="${DOCKER_BUILD_USERNAME}" -p="${DOCKER_BUILD_PASSWORD}" "${DEV_REGISTRY%%/*}"
          else
            echo >>"$BASH_ENV" 'if test -e ~/kubernaut-claim.txt; then'
            echo >>"$BASH_ENV" '  KUBECONFIG=$DEV_KUBECONFIG go run ./cmd/k8sregistryctl up --storage=hostPath'
            echo >>"$BASH_ENV" '  export DEV_REGISTRY=127.0.0.1:31000'
            echo >>"$BASH_ENV" 'fi'
          fi
          echo >>"$BASH_ENV" unset BASH_ENV
    - run:
        name: "Build"
        command: |
          make push
    - run:
        name: "Go Tests"
        command: |
          make gotest
    - # XXX The three KAT runs should really be split out into separate parallel jobs.
      # Circle makes that hard enough that we're not going to do it just yet, though.
      run:
        name: "KAT (normal)"
        command: |
          export DEV_KUBE110=yes
          export DEV_KUBE_NO_PVC=yes
          export KAT_REQ_LIMIT=600
          make pytest-only
    - run:
        name: "Cycle cluster"
        command: |
          ./.ci/kubernaut-unclaim
          ./.ci/kubernaut-claim
    - run:
        name: "KAT (FAST_VALIDATION)"
        command: |
          export DEV_KUBE110=yes
          export DEV_KUBE_NO_PVC=yes
          export KAT_REQ_LIMIT=600
          export AMBASSADOR_FAST_VALIDATION=true
          make pytest-only
    - run:
        name: "Cycle cluster"
        command: |
          ./.ci/kubernaut-unclaim
          ./.ci/kubernaut-claim
    - run:
        name: "KAT (FAST_VALIDATION and FAST_RECONFIGURE)"
        command: |
          export DEV_KUBE110=yes
          export DEV_KUBE_NO_PVC=yes
          export KAT_REQ_LIMIT=600
          export AMBASSADOR_FAST_VALIDATION=true
          export AMBASSADOR_FAST_RECONFIGURE=true
          make pytest-only
    - # We might want to run ingress-conformance tests in AES in the future
      # This would require we install `kind` on circleci and that the test suite
      # supports HTTP to HTTPS redirects (AES enables cleartext redirection by
      # default, even for fallback hosts, contrary to AOSS)
      # - run:
      #     name: "Ingress Conformance Tests"
      #     command: |
      #       export DEV_KUBE110=yes
      #       make ingresstest
      run:
        command: "./.ci/kubernaut-unclaim"
        when: "always"
    - dirty-check
    - amb-save-logs
  "aes-images-build-and-test":
    parameters:
      fast:
        default: "false"
        type: string
      go_tests:
        default: true
        type: boolean
      kat_tests:
        default: true
        type: boolean
      e2e_tests:
        default: true
        type: boolean
    steps:
    - run:
        name: "Ensure CI configuration is up-to-date"
        command: |
          set -x
          test_targets=$(make -n noop --print-data-base 2>/dev/null | sed -n 's/^test: *//p' | xargs printf '%s\n' | LC_COLLATE=C sort -u | xargs echo)
          if [ "$test_targets" != "e2etest gotest ingresstest pytest" ]; then
            echo "Makefile 'test' target has changed to $test_targets, you need to update '.circleci/config.yml.d/aes.yml'" >&2
            exit 1
          fi

          (cd .circleci && ./generate --always-make)
          if test -n "$(git status --porcelain)"; then
            echo "The file '.circleci/config.yml' is out of date." >&2
            echo "Run '(cd .circleci && ./generate)' to update it." >&2
            exit 1
          fi
    - run:
        name: "Build"
        command: |
          docker login -u="${DOCKER_BUILD_USERNAME}" -p="${DOCKER_BUILD_PASSWORD}" "${DEV_REGISTRY%%/*}"
          ./ambassador/.ci/kubernaut-claim
          export DEV_KUBECONFIG=~/.kube/$(cat ~/kubernaut-claim.txt).yaml
          make push
    - when:
        condition: <<parameters.go_tests>>
        steps:
        - run:
            name: "Go Tests"
            command: |
              export DEV_KUBECONFIG=~/.kube/$(cat ~/kubernaut-claim.txt).yaml
              make gotest
    - when:
        condition: <<parameters.kat_tests>>
        steps:
        - run:
            name: "KAT (fast=<<parameters.fast>>)"
            command: |
              export DEV_KUBECONFIG=~/.kube/$(cat ~/kubernaut-claim.txt).yaml
              export DEV_KUBE110=yes
              export DEV_KUBE_NO_PVC=yes
              export KAT_REQ_LIMIT=600
              export AMBASSADOR_FAST_RECONFIGURE=<<parameters.fast>>
              export AMBASSADOR_FAST_VALIDATION=<<parameters.fast>>
              make pytest-only
    - # We might want to run ingress-conformance tests in AES in the future
      # This would require we install `kind` on circleci and that the test suite
      # supports HTTP to HTTPS redirects (AES enables cleartext redirection by
      # default, even for fallback hosts, contrary to AOSS)
      # - run:
      #     name: "Ingress Conformance Tests"
      #     command: |
      #       export DEV_KUBECONFIG=~/.kube/$(cat ~/kubernaut-claim.txt).yaml
      #       export DEV_KUBE110=yes
      #       make ingresstest
      when:
        condition: <<parameters.e2e_tests>>
        steps:
        - run:
            name: "E2E Tests (fast=<<parameters.fast>>)"
            command: |
              export DEV_KUBECONFIG=~/.kube/$(cat ~/kubernaut-claim.txt).yaml
              export DEV_KUBE110=yes
              export DEV_KUBE_NO_PVC=yes
              export AMBASSADOR_FAST_RECONFIGURE=<<parameters.fast>>
              export AMBASSADOR_FAST_VALIDATION=<<parameters.fast>>
              make e2etest
    - run:
        command: "./ambassador/.ci/kubernaut-unclaim"
        when: "always"
    - dirty-check
    - amb-save-logs
  amb-linux-install:
    steps:
    - install-python:
        executor-key: "202008-01"
    - pip-install:
        packages: awscli packaging
    - install-go
    - install-kubectl
    - install-node
  amb-checkout:
    steps:
    - when:
        condition:
          or:
          - equal:
            - "https://github.com/datawire/ambassador"
            - << pipeline.project.git_url >>
          - equal:
            - "https://github.com/datawire/ambassador-private"
            - << pipeline.project.git_url >>
        steps:
        - checkout:
            path: ~/project/ambassador
    - when:
        condition:
          or:
          - equal:
            - "https://github.com/datawire/apro"
            - << pipeline.project.git_url >>
          - equal:
            - "https://github.com/datawire/apro-private"
            - << pipeline.project.git_url >>
        steps:
        - run:
            working_directory: ~/project
            command: "rmdir ~/project/ambassador || true"
        - checkout:
            path: ~/project
  amb-save-logs:
    steps:
    - run:
        name: "Gather logs"
        when: always
        command: |
          rsync -ma --include='*/' --include='*.tap' --include='*.log' --include='Test*.webm' --exclude='*' . /tmp/test-logs
    - store_artifacts:
        name: "Store logs"
        path: /tmp/test-logs
        destination: test-logs
  website-setup:
    steps:
    - install-node:
        version: "11"
    - install-yarn
    - install-python:
        executor-key: "202008-01"
        version: "3.7.0"
    - run:
        name: "Show environment"
        command: |
          env | grep -e GIT -e TRAVIS -e CIRCLE | sort
    - amb-checkout
    - skip-if-no-changes:
        to: docs/
  pip-install:
    parameters:
      packages:
        type: string
    steps:
    - run: |
        if [[ "$(which pip3)" == *pyenv* ]]; then
          pip3 install << parameters.packages >>
        else
          sudo pip3 install << parameters.packages >>
        fi
  install-node:
    parameters:
      version:
        type: string
        default: "10"
    steps:
    - run:
        name: "Install Node << parameters.version >>"
        command: |
          echo 'export NVM_DIR=/opt/circleci/.nvm' >> ${BASH_ENV}
          echo 'source $NVM_DIR/nvm.sh' >> ${BASH_ENV}

          export NVM_DIR=/opt/circleci/.nvm
          source $NVM_DIR/nvm.sh
          if ! nvm ls << parameters.version >> > /dev/null; then nvm install << parameters.version >>; fi
          nvm alias default << parameters.version >>
  install-go:
    parameters:
      version:
        type: string
        default: "1.15"
    steps:
    - run:
        name: "Install Go << parameters.version >>"
        command: |
          set -x
          if [[ $OS == Windows_NT ]]; then
            curl https://dl.google.com/go/go<< parameters.version >>.windows-amd64.zip -o /tmp/go.zip
            mv /c/go /c/go-112
            unzip -q /tmp/go.zip -d /c/
          else
            curl https://dl.google.com/go/go<< parameters.version >>.$(uname -s | tr A-Z a-z)-amd64.tar.gz -o /tmp/go.tar.gz
            tar -C /tmp -xzf /tmp/go.tar.gz
            echo 'export PATH=/tmp/go/bin:$PATH' >> "$BASH_ENV"
            if [ -z "$(/tmp/go/bin/go env GOPROXY)" ]; then
              echo 'export GOPROXY=https://proxy.golang.org' >> "$BASH_ENV"
            fi
            . "$BASH_ENV"
          fi
          go version
  install-kubectl:
    parameters:
      version:
        type: string
        default: "1.14.0"
    steps:
    - run:
        name: "Install kubectl << parameters.version >>"
        command: |
          curl -L --fail -o /tmp/kubectl https://storage.googleapis.com/kubernetes-release/release/v<< parameters.version >>/bin/$(uname -s | tr A-Z a-z)/amd64/kubectl
          sudo install /tmp/kubectl /usr/local/bin/kubectl
  install-yarn:
    steps:
    - run:
        name: "Install Yarn"
        command: |
          curl -o- -L https://yarnpkg.com/install.sh | bash
          echo 'PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"' >> "$BASH_ENV"
  install-python:
    parameters:
      version:
        type: string
        default: "3.6.3"
      pip-version:
        type: string
        default: "20.1.1"
      executor-key:
        type: string
    steps:
    - restore_cache:
        name: "Restore Python install cache"
        key: "pyenv-<< parameters.executor-key >>-<< parameters.version >>-<< parameters.pip-version
          >>"
    - run:
        name: "Install Python << parameters.version >>"
        command: |
          set -x
          pyenv versions
          pyenv install --skip-existing << parameters.version >>
          pyenv global 2.7.18 << parameters.version >>
          pyenv versions
          pip3 install pip==<< parameters.pip-version>>
    - save_cache:
        name: "Save Python install cache"
        key: "pyenv-<< parameters.executor-key >>-<< parameters.version >>-<< parameters.pip-version
          >>"
        paths:
        - "/opt/circleci/.pyenv"
  dirty-check:
    steps:
    - run:
        name: "Dirty check"
        command: |
          # On Windows, `git status` doesn't record no-op
          # line-ending changes in to the index, so things show as
          # dirty even if they aren't.  Trying to `add` them does
          # trigger the appropriate index update.  So do a `git add`
          # *before* the `git status --porcelain` to work around
          # Windows being terrible; we'd otherwise put the `git add`
          # inside of the `if` block to help generate better output
          # for `git diff`.
          git add .
          if [[ -n "$(git status --porcelain)" ]]; then
             PAGER= git diff --cached
             exit 1
          fi
  skip-if-no-changes:
    parameters:
      to:
        description: A POSIX ERE (grep -E regex) that matches which filenames to check
          for changes in
        type: string
    steps:
    - run:
        name: "Diff changes"
        command: |
          if [[ "<< pipeline.git.base_revision >>" == "" ]]; then
            echo "There is no base_revision, therefore no changes"
            exit 0
          fi

          COMMIT_RANGE="<< pipeline.git.base_revision >>...<<pipeline.git.revision>>"
          echo "Commit range: " $COMMIT_RANGE
          git --no-pager diff $COMMIT_RANGE --name-only

          if [[ $(git --no-pager diff $COMMIT_RANGE --name-only | grep -E "<< parameters.to >>") == "" ]]; then
            echo "Halting this CircleCI job because code in the following paths have not changed:"
            echo "<< parameters.to >>"
            circleci step halt
          fi
  skip-if-only-changes:
    parameters:
      to:
        description: A POSIX ERE (grep -E regex) that matches which filenames to check
          for changes in
        type: string
    steps:
    - run:
        name: "Diff changes"
        command: |
          if [[ "<< pipeline.git.base_revision >>" == "" ]]; then
            echo "There is no base_revision, therefore no changes"
            exit 0
          fi

          COMMIT_RANGE="<< pipeline.git.base_revision >>...<<pipeline.git.revision>>"
          echo "Commit range: " $COMMIT_RANGE
          git --no-pager diff $COMMIT_RANGE --name-only

          if [[ $(git --no-pager diff $COMMIT_RANGE --name-only | grep -v -E "<< parameters.to >>") == "" ]]; then
            echo "Halting this CircleCI job because only code in the following paths has changed:"
            echo "<< parameters.to >>"
            circleci step halt
          fi
jobs:
  oss-dev-generate:
    executor: oss-linux
    steps:
    - amb-linux-install
    - amb-checkout
    - run: make generate
    - dirty-check
    - run: make generate
    - dirty-check
  oss-dev-lint:
    executor: oss-linux
    steps:
    - amb-linux-install
    - amb-checkout
    - run: make lint
  oss-dev-images:
    executor: oss-linux
    steps:
    - amb-linux-install
    - amb-checkout
    - skip-if-only-changes:
        to: docs/
    - oss-images-build-and-test
  oss-release-images:
    executor: oss-linux
    steps:
    - amb-linux-install
    - amb-checkout
    - oss-images-build-and-test
    - run:
        name: "Release"
        command: |
          docker login -u="${DOCKER_RELEASE_USERNAME}" -p="${DOCKER_RELEASE_PASSWORD}" "${RELEASE_REGISTRY%%/*}"
          DEV_KUBECONFIG="-skip-for-release-" make release/bits
  oss-release-promote-to-rc-latest:
    executor: oss-linux
    steps:
    - amb-linux-install
    - amb-checkout
    - when:
        condition:
          equal:
          - "https://github.com/datawire/ambassador"
          - << pipeline.project.git_url >>
        steps:
        - run:
            name: "Promote to -rc-latest"
            command: |
              docker login -u="${DOCKER_RELEASE_USERNAME}" -p="${DOCKER_RELEASE_PASSWORD}" "${RELEASE_REGISTRY%%/*}"
              DEV_KUBECONFIG="-skip-for-release-" make release/promote-oss/to-rc-latest
  oss-release-promote-to-ga:
    executor: oss-linux
    steps:
    - amb-linux-install
    - amb-checkout
    - run:
        name: "Promote to GA"
        command: |
          docker login -u="${DOCKER_RELEASE_USERNAME}" -p="${DOCKER_RELEASE_PASSWORD}" "${RELEASE_REGISTRY%%/*}"
          DEV_KUBECONFIG="-skip-for-release-" make release/promote-oss/to-ga
  website-preview-build:
    executor: oss-linux
    steps:
    - website-setup
    - run: ./.ci/website-preview-build
    - persist_to_workspace:
        root: /tmp/getambassador.io
        paths:
        - public
  website-preview-publish:
    executor: oss-linux
    steps:
    - website-setup
    - attach_workspace:
        at: /tmp/getambassador.io
    - run: ./.ci/website-preview-publish
  website-preview-blc:
    executor: oss-linux
    steps:
    - website-setup
    - attach_workspace:
        at: /tmp/getambassador.io
    - run: ./.ci/website-preview-blc
    - store_artifacts:
        path: /tmp/blc.txt
        destination: blc.txt
  website-preview-for-smoketest:
    executor: oss-linux
    steps:
    - website-setup
    - run: ./.ci/website-preview-build
    - run: ./.ci/website-preview-publish
  website-prod-publish:
    executor: oss-linux
    steps:
    - website-setup
    - run:
        name: "Configure Git user"
        command: |
          git config --global user.name 'ambassador.git CircleCI user'
          git config --global user.email dev@datawire.io
    - run: ./.ci/website-prod-publish
workflows:
  'OSS: Dev':
    jobs:
    - "oss-dev-images"
    - "oss-dev-generate"
    - "oss-dev-lint"
  'OSS: Release':
    when:
      or:
      - equal:
        - "https://github.com/datawire/ambassador"
        - << pipeline.project.git_url >>
      - equal:
        - "https://github.com/datawire/ambassador-private"
        - << pipeline.project.git_url >>
    jobs:
    - oss-release-images:
        filters:
          tags:
            only: /^v[0-9]+\.[0-9]+\.[0-9]+-(rc|ea)\.[0-9]+$/
          branches:
            ignore: /.*/
    - oss-release-promote-to-rc-latest:
        requires:
        - "oss-release-images"
        filters:
          tags:
            only: /^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$/
          branches:
            ignore: /.*/
    - oss-release-promote-to-ga:
        filters:
          tags:
            only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
          branches:
            ignore: /.*/
  'Docs: Dev':
    jobs:
    - website-preview-build:
        filters:
          branches:
            ignore:
            # Don't bother running on forked PRs (which CircleCI
            # shows as branch="pull/${number}"); they won't have
            # GH_TOKEN set to be able to pull getambassador.io.git
            - /^pull\/[0-9]+$/
    - website-preview-publish:
        requires:
        - "website-preview-build"
        filters:
          branches:
            ignore:
            # Don't bother running on 'master' or the other
            # branches that we do the "Release" workflow for.
            - master
            - /^release\/v1\.[0-9]+$/
            # Don't bother running on forked PRs (which CircleCI
            # shows as branch="pull/${number}"); they won't have
            # GH_TOKEN set to be able to pull getambassador.io.git
            - /^pull\/[0-9]+$/
            # Don't bother running the BLC until we've taught it to ignore
            # broken links from the CMS that the PR author can't do anything
            # about.  Count on Kenn watching it in getambassador.io.git, and
            # mocking any devs that write broken links.
            #
            #- "website-preview-blc":
            #    requires: ["website-preview-build"]
            #    filters:
            #      branches:
            #        ignore:
            #          # Don't bother running on forked PRs (which CircleCI
            #          # shows as branch="pull/${number}"); they won't have
            #          # GH_TOKEN set to be able to pull getambassador.io.git
            #          - /^pull\/[0-9]+$/
  'Docs: Prerelease':
    when:
      equal:
      - "https://github.com/datawire/apro"
      - << pipeline.project.git_url >>
    jobs:
    - website-preview-for-smoketest:
        filters:
          tags:
            only: /^v[0-9]+\.[0-9]+\.[0-9]+-(rc|ea)\.[0-9]+$/
          branches:
            ignore: /.*/
  'Docs: Release':
    when:
      equal:
      - "https://github.com/datawire/ambassador"
      - << pipeline.project.git_url >>
    jobs:
    - website-prod-publish:
        filters:
          branches:
            only:
            - master
            - /^release\/v1\.[0-9]+$/
executors:
  oss-linux:
    machine:
      image: "ubuntu-2004:202008-01"
    working_directory: ~/project/ambassador
  aes-linux:
    machine:
      image: "ubuntu-2004:202008-01"
    working_directory: ~/project
